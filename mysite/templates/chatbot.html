<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ß–∞—Ç-–±–æ—Ç –ø–æ–º—ñ—á–Ω–∏–∫ - –ú–µ–º–Ω–∏–π –ë–ª–æ–≥</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .chat-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        height: 70vh;
        display: flex;
        flex-direction: column;
      }
      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px 15px 0 0;
      }
      .message {
        margin-bottom: 15px;
        max-width: 80%;
      }
      .user-message {
        margin-left: auto;
      }
      .user-message .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px 15px;
        border-radius: 20px 20px 5px 20px;
      }
      .bot-message .message-bubble {
        background: white;
        border: 1px solid #dee2e6;
        padding: 10px 15px;
        border-radius: 20px 20px 20px 5px;
        white-space: pre-line;
      }
      .message-time {
        font-size: 0.8em;
        color: #6c757d;
        margin-top: 5px;
      }
      .chat-input {
        padding: 20px;
        background: white;
        border-radius: 0 0 15px 15px;
        border-top: 1px solid #dee2e6;
      }
      .bot-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: linear-gradient(135deg, #28a745, #20c997);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .user-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-bottom: 5px;
        margin-left: auto;
      }
      .typing-indicator {
        display: none;
      }
      .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #6c757d;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite;
      }
      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes typing {
        0%,
        20% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
        80%,
        100% {
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="{% url 'blog' %}">ü§£ –ú–µ–º–Ω–∏–π –ë–ª–æ–≥</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <div class="navbar-nav me-auto">
            <a class="nav-link" href="{% url 'index' %}">–ì–æ–ª–æ–≤–Ω–∞</a>
            <a class="nav-link" href="{% url 'blog' %}">–ë–ª–æ–≥</a>
            <a class="nav-link" href="{% url 'news' %}">–ù–æ–≤–∏–Ω–∏</a>
            <a class="nav-link" href="{% url 'about' %}">–ü—Ä–æ –Ω–∞—Å</a>
            <a class="nav-link" href="{% url 'contact' %}">–ö–æ–Ω—Ç–∞–∫—Ç–∏</a>
          </div>
          <div class="navbar-nav">
            <a class="nav-link" href="{% url 'profile' %}"
              >üë§ {{ user.username }}</a
            >
            <a class="nav-link" href="{% url 'logout' %}">–í–∏—Ö—ñ–¥</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card chat-container">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">
                <i class="fas fa-robot"></i>
                –ß–∞—Ç-–±–æ—Ç –ø–æ–º—ñ—á–Ω–∏–∫
                <small class="ms-2">–î–æ–ø–æ–º–æ–∂—É –∑–Ω–∞–π—Ç–∏ —Å—Ç–∞—Ç—Ç—ñ —Ç–∞ –Ω–æ–≤–∏–Ω–∏!</small>
              </h5>
            </div>

            <div class="chat-messages" id="chatMessages">
              <!-- –ü—Ä–∏–≤—ñ—Ç–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
              <div class="message bot-message">
                <div class="bot-avatar">ü§ñ</div>
                <div class="message-bubble">
                  –ü—Ä–∏–≤—ñ—Ç, {{ user.username }}! üëã –Ø –≤–∞—à –ø–æ–º—ñ—á–Ω–∏–∫ –¥–ª—è –ø–æ—à—É–∫—É
                  —Å—Ç–∞—Ç–µ–π —Ç–∞ –Ω–æ–≤–∏–Ω –Ω–∞ —Å–∞–π—Ç—ñ. –í–∏ –º–æ–∂–µ—Ç–µ –∑–∞–ø–∏—Ç–∞—Ç–∏ –º–µ–Ω–µ: ‚Ä¢ "–º–µ–º –ø—Ä–æ
                  –∫–æ—Ç—ñ–≤" - –∑–Ω–∞–π–¥—É —Å—Ç–∞—Ç—Ç—ñ –ø—Ä–æ –∫–æ—Ç—ñ–≤ ‚Ä¢ "–Ω–æ–≤–∏–Ω–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ–π" -
                  –ø–æ–∫–∞–∂—É –æ—Å—Ç–∞–Ω–Ω—ñ –Ω–æ–≤–∏–Ω–∏ ‚Ä¢ "–ø–æ–ø—É–ª—è—Ä–Ω–µ" - –Ω–∞–π–ø–æ–ø—É–ª—è—Ä–Ω—ñ—à—ñ —Å—Ç–∞—Ç—Ç—ñ
                  –ü—Ä–æ —â–æ —Ö–æ—á–µ—Ç–µ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è?
                </div>
              </div>

              <!-- –Ü—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—É -->
              {% for chat in chat_history reversed %}
              <div class="message user-message">
                <div class="user-avatar">{{ user.username|first|upper }}</div>
                <div class="message-bubble">{{ chat.message }}</div>
                <div class="message-time text-end">
                  {{ chat.timestamp|time:"H:i" }}
                </div>
              </div>
              <div class="message bot-message">
                <div class="bot-avatar">ü§ñ</div>
                <div class="message-bubble">{{ chat.response }}</div>
              </div>
              {% endfor %}

              <!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥—Ä—É–∫—É -->
              <div
                class="message bot-message typing-indicator"
                id="typingIndicator"
              >
                <div class="bot-avatar">ü§ñ</div>
                <div class="message-bubble">
                  <span class="typing-dot"></span>
                  <span class="typing-dot"></span>
                  <span class="typing-dot"></span>
                </div>
              </div>
            </div>

            <div class="chat-input">
              <form id="chatForm" class="d-flex">
                {% csrf_token %}
                <input
                  type="text"
                  id="messageInput"
                  class="form-control me-2"
                  placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è..."
                  autocomplete="off"
                />
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </form>
            </div>
          </div>

          <div class="text-center mt-3">
            <small class="text-white">
              üí° –ü—ñ–¥–∫–∞–∑–∫–∞: –°–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø–∏—Ç–∞—Ç–∏ "–º–µ–º", "–Ω–æ–≤–∏–Ω–∏", "—Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó" –∞–±–æ
              "–ø–æ–ø—É–ª—è—Ä–Ω–µ"
            </small>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script>
      const chatForm = document.getElementById("chatForm");
      const messageInput = document.getElementById("messageInput");
      const chatMessages = document.getElementById("chatMessages");
      const typingIndicator = document.getElementById("typingIndicator");
      const csrfToken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;

      chatForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const message = messageInput.value.trim();
        if (!message) return;

        // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        addUserMessage(message);
        messageInput.value = "";

        // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥—Ä—É–∫—É
        showTypingIndicator();

        try {
          const response = await fetch('{% url "chatbot" %}', {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrfToken,
            },
            body: JSON.stringify({ message: message }),
          });

          const data = await response.json();

          // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥—Ä—É–∫—É
          hideTypingIndicator();

          if (data.error) {
            addBotMessage("‚ùå " + data.error);
          } else {
            addBotMessage(data.response, data.timestamp);
          }
        } catch (error) {
          hideTypingIndicator();
          addBotMessage("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.");
        }
      });

      function addUserMessage(message) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message user-message";
        messageDiv.innerHTML = `
                <div class="user-avatar">{{ user.username|first|upper }}</div>
                <div class="message-bubble">${escapeHtml(message)}</div>
                <div class="message-time text-end">${getCurrentTime()}</div>
            `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      function addBotMessage(response, timestamp = null) {
        const messageDiv = document.createElement("div");
        messageDiv.className = "message bot-message";
        messageDiv.innerHTML = `
                <div class="bot-avatar">ü§ñ</div>
                <div class="message-bubble">${escapeHtml(response)}</div>
                ${
                  timestamp
                    ? `<div class="message-time">${timestamp}</div>`
                    : ""
                }
            `;
        chatMessages.appendChild(messageDiv);
        scrollToBottom();
      }

      function showTypingIndicator() {
        typingIndicator.style.display = "block";
        scrollToBottom();
      }

      function hideTypingIndicator() {
        typingIndicator.style.display = "none";
      }

      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString("uk-UA", {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ñ–æ–∫—É—Å—É–≤–∞–Ω–Ω—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥—É
      messageInput.focus();

      // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –Ω–∏–∑—É –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
      scrollToBottom();
    </script>
  </body>
</html>
